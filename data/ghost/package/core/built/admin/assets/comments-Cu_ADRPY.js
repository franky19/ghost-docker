import{j as e,y as D,r as c,cU as A,cV as V,bS as _,ci as B,cW as q,B as j,ak as Q,ad as F,c2 as W,bX as N,bY as C,bZ as k,cC as X,b_ as y,aj as S,bB as Y,cX as K,aW as Z,ap as G,aX as J,aY as ee,a_ as R,x as se,a0 as te,a1 as ae,a2 as re,a3 as ne,a4 as oe,a5 as le,a6 as ie,a7 as ce,bp as de,bR as ue,f as me,cY as he}from"./index-DQyPmpGB.js";import{F as pe,c as fe}from"./filters-De2XhgpZ.js";import{u as xe}from"./posts-C7K9oIZ5.js";import{M as ge,c as be,a as je,F as ve,e as we,b as Ne,D as E,E as Ce,f as ke,C as ye}from"./message-square-text-C7V7BkDm.js";import{H as z,g as Se,u as _e}from"./use-infinite-virtual-scroll-Dr4yDVqZ.js";import{M as Te}from"./main-layout-d13UKLRL.js";import{a as Pe,b as De,c as T,d as $,e as Fe,f as P}from"./table-ezlpPvP1.js";import{R as Me}from"./reply-BxReOZlh.js";import{E as Re}from"./empty-indicator-CYjCOvfy.js";const Ee=({children:a,className:s,...t})=>e.jsx("section",{className:D("flex gap-6 flex-col p-4 lg:p-8 size-full grow",s),...t,children:a});function I({knownItems:a,useSearch:s,filters:t,filterFieldName:r,searchFieldName:n,toOption:i}){const[d,l]=c.useState(""),{data:m,isLoading:p}=s(d),h=m?.[n]??[],g=c.useCallback(f=>i(f),[i]);return{options:c.useMemo(()=>{const f={};for(const u of a)f[u.id]=g(u);for(const u of h??[])f[u.id]=g(u);const x=t.find(u=>u.field===r);if(x&&x.values[0]){const u=String(x.values[0]);u in f||(f[u]={value:u,label:`ID: ${u}`})}return Object.values(f)},[a,h,t,r,g]),isLoading:p,searchValue:d,onSearchChange:l}}function ze(a){const[s]=A(a,200);return V({searchParams:{...s&&{search:s},limit:"100",order:"created_at DESC"}})}function $e(a){const[s]=A(a,200),t=s?`title:~'${s.replace(/'/g,"\\'")}'`:"";return xe({searchParams:{...t&&{filter:t},limit:"100",fields:"id,title",order:"published_at DESC"}})}const Ie=({knownPosts:a,knownMembers:s,filters:t,onFiltersChange:r})=>{const n=I({knownItems:a,useSearch:$e,searchFieldName:"posts",filters:t,filterFieldName:"post",toOption:h=>({value:h.id,label:h.title||"(Untitled)"})}),i=I({knownItems:s,useSearch:ze,searchFieldName:"members",filters:t,filterFieldName:"author",toOption:h=>({value:h.id,label:h.name||"Unknown name",detail:h.email??"(Unknown email)"})}),d=c.useMemo(()=>[{key:"author",label:"Author",type:"select",icon:e.jsx(_,{className:"size-4"}),options:i.options,isLoading:i.options.length===0&&i.isLoading,onSearchChange:i.onSearchChange,searchValue:i.searchValue,searchable:!0,className:"w-80",popoverContentClassName:"w-80",operators:[{value:"is",label:"is"},{value:"is_not",label:"is not"}]},{key:"post",label:"Post",type:"select",icon:e.jsx(B,{className:"size-4"}),options:n.options,isLoading:n.options.length===0&&n.isLoading,onSearchChange:n.onSearchChange,searchValue:n.searchValue,searchable:!0,className:"w-80",popoverContentClassName:"w-80",operators:[{value:"is",label:"is"},{value:"is_not",label:"is not"}]},{key:"body",label:"Text",type:"text",icon:e.jsx(ge,{className:"size-4"}),placeholder:"Search comment text...",operators:[{value:"contains",label:"contains"},{value:"not_contains",label:"does not contain"}],defaultOperator:"contains",className:"w-48",popoverContentClassName:"w-48"},{key:"status",label:"Status",type:"select",icon:e.jsx(q,{className:"size-4"}),options:[{value:"published",label:"Published"},{value:"hidden",label:"Hidden"}]},{key:"reported",label:"Reported",type:"select",icon:e.jsx(be,{className:"size-4"}),options:[{value:"true",label:"Yes"},{value:"false",label:"No"}]},{key:"created_at",label:"Date",type:"date",className:"w-32",icon:e.jsx(je,{className:"size-4"}),operators:[{value:"is",label:"is"},{value:"before",label:"before"},{value:"after",label:"after"}]}],[n,i]),l=t.length>0,m=c.useCallback(()=>{r([])},[r]),p=D("flex flex-row justify-between",!l&&"[grid-area:actions] ",l&&"col-start-1 col-end-4 row-start-3 pt-7 ");return e.jsxs("div",{className:p,children:[e.jsx(pe,{addButtonIcon:l?e.jsx(ve,{}):e.jsx(we,{}),addButtonText:l?"Add filter":"Filter",className:`[&>button]:order-last ${l&&"[&>button]:border-none"}`,fields:d,filters:t,keyboardShortcut:"f",popoverAlign:l?"start":"end",onChange:r}),l&&e.jsxs(j,{className:"font-normal text-muted-foreground",variant:"ghost",onClick:m,children:[e.jsx(Ne,{}),"Clear"]})]})},Le=({children:a})=>e.jsxs(z,{className:"!pb-6",variant:"inline-nav",children:[e.jsx(z.Title,{children:"Comments"}),a]}),He=({children:a})=>e.jsx(Te,{children:e.jsx("div",{className:"grid w-full grow",children:e.jsx("div",{className:"flex h-full flex-col","data-testid":"comments-page",children:a})})}),Ae="CommentsResponseType",Ue=Q({dataType:Ae,path:"/comments/",defaultNextPageParams:(a,s)=>{var t,r;return(t=a.meta)!=null&&t.pagination.next?{...s,page:(((r=a.meta)==null?void 0:r.pagination.next)||1).toString()}:void 0},returnData:a=>{const{pages:s}=a,t=s.flatMap(n=>n.comments),r=s[s.length-1].meta;return{comments:t,meta:r,isEnd:r?r.pagination.pages===r.pagination.page:!0}}}),Oe=a=>Ue({...a,searchParams:{limit:"100",order:"created_at desc",include:"member,post",...a?.searchParams}}),Ve=F({method:"PUT",path:({id:a})=>`/comments/${a}/`,body:({id:a})=>({comments:[{id:a,status:"hidden"}]}),invalidateQueries:{dataType:"CommentsResponseType"}}),Be=F({method:"PUT",path:({id:a})=>`/comments/${a}/`,body:({id:a})=>({comments:[{id:a,status:"published"}]}),invalidateQueries:{dataType:"CommentsResponseType"}}),qe=F({method:"PUT",path:({id:a})=>`/comments/${a}/`,body:({id:a})=>({comments:[{id:a,status:"deleted"}]}),invalidateQueries:{dataType:"CommentsResponseType"}}),L=new Map;function Qe({parentRef:a,enabled:s=!0,isLoading:t=!1}){const r=W(),[n,i]=c.useState(null),d=c.useRef(null);c.useEffect(()=>{if(!s||!a.current)return;const l=Se(a.current);i(l)},[s,a]),c.useEffect(()=>{if(!s||!n)return;const l=r.pathname+r.search,m=()=>{const p=n.scrollTop;L.set(l,p)};return n.addEventListener("scroll",m),()=>n.removeEventListener("scroll",m)},[s,r.pathname,r.search,n]),c.useEffect(()=>{const l=r.pathname+r.search,m=L.get(l);if(!(!s||!n||t)){if(m!==void 0&&d.current!==l){let p=0;const h=3,g=()=>{if(p+=1,!n)return;const f=n.scrollTop,x=n.scrollHeight,u=n.clientHeight,w=x-u;if(m>w&&p<h){setTimeout(g,100);return}if(Math.abs(m-f)>5){const b=Math.min(m,w);n.scrollTop=b}},v=setTimeout(g,150);return()=>clearTimeout(v)}d.current=l}},[s,r.pathname,r.search,n,t])}const H=({height:a})=>e.jsx("tr",{"aria-hidden":"true",className:"flex lg:table-row",children:e.jsx("td",{className:"flex lg:table-cell",style:{height:a}})}),We=c.forwardRef(function(s,t){return e.jsx(T,{ref:t,...s,"aria-hidden":"true",className:"relative flex flex-col lg:table-row",children:e.jsx(P,{className:"relative z-10 h-24 animate-pulse",children:e.jsx("div",{className:"h-full rounded-md bg-muted","data-testid":"loading-placeholder"})})})});function Xe(a){const s=new Date(a);return new Intl.DateTimeFormat("en-US",{month:"short",day:"numeric",year:"numeric",hour:"numeric",minute:"numeric"}).format(s).replace(/(\d+),(\s+\d{4})/,"$1$2")}function Ye({onClick:a,expanded:s}){return e.jsxs(j,{className:"shrink-0 gap-0.5 self-start p-0 text-muted-foreground hover:bg-transparent",size:"sm",variant:"ghost",onClick:a,children:[s?"Show less":"Show more",s?e.jsx(ye,{}):e.jsx(de,{})]})}function Ke({item:a}){const s=c.useRef(null),[t,r]=c.useState(!1),[n,i]=c.useState(!1);return c.useEffect(()=>{const d=()=>{s.current&&r(s.current.scrollHeight>s.current.clientHeight)};return d(),window.addEventListener("resize",d),()=>window.removeEventListener("resize",d)},[a.html]),e.jsx("div",{className:"mt-1 flex flex-col gap-2",children:e.jsxs("div",{className:"flex max-w-[720px] flex-col items-start",children:[e.jsx("div",{dangerouslySetInnerHTML:{__html:a.html||""},ref:s,className:D("prose flex-1 text-base leading-[1.45em] [&_*]:text-base [&_*]:font-normal [&_blockquote]:border-l-[3px] [&_blockquote]:border-foreground [&_blockquote]:p-0 [&_blockquote]:pl-3 [&_blockquote_p]:mt-0 [&_a]:underline",n?"-mb-1 [&_p]:mb-[0.85em]":"line-clamp-2 [&_p]:m-0 [&_blockquote+p]:mt-1",a.status==="hidden"&&"text-muted-foreground [&_blockquote]:border-foreground-muted")}),t&&e.jsx(Ye,{expanded:n,onClick:()=>i(!n)})]})})}function Ze({items:a,totalItems:s,hasNextPage:t,isFetchingNextPage:r,fetchNextPage:n,onAddFilter:i,isLoading:d}){const l=c.useRef(null);Qe({parentRef:l,isLoading:d});const{visibleItems:m,spaceBefore:p,spaceAfter:h}=_e({items:a,totalItems:s,hasNextPage:t,isFetchingNextPage:r,fetchNextPage:n,parentRef:l}),{mutate:g}=Ve(),{mutate:v}=Be(),{mutate:f}=qe(),[x,u]=c.useState(null),w=()=>{x&&(f({id:x.id}),u(null))};return e.jsxs("div",{ref:l,className:"overflow-hidden",children:[e.jsxs(Pe,{className:"flex table-fixed flex-col lg:table","data-testid":"comments-list",children:[e.jsx(De,{className:"hidden lg:!visible lg:!table-header-group",children:e.jsxs(T,{children:[e.jsx($,{className:"h-0 px-4 py-0"}),e.jsx($,{className:"h-0 w-36 px-4 py-0"})]})}),e.jsxs(Fe,{className:"flex flex-col lg:table-row-group",children:[e.jsx(H,{height:p}),m.map(({key:b,virtualItem:O,item:o,props:M})=>O.index>a.length-1?e.jsx(We,{...M},b):e.jsxs(T,{...M,className:"grid w-full grid-cols-[1fr_5rem] items-center gap-x-4 p-2 hover:bg-muted/50 md:grid-cols-[1fr_auto_5rem] lg:table-row lg:p-0 [&.group:hover_td]:bg-transparent","data-testid":"comment-list-row",children:[e.jsx(P,{className:"static col-start-1 col-end-1 row-start-1 row-end-1 flex min-w-0 flex-col p-4 md:relative lg:table-cell",children:e.jsxs("div",{className:"flex flex-col gap-3",children:[e.jsxs("div",{className:"flex flex-wrap items-center",children:[o.member?.id?e.jsx(e.Fragment,{children:e.jsxs(j,{className:`flex h-auto items-center gap-1.5 truncate p-0 font-semibold text-primary hover:opacity-70 ${o.status==="hidden"&&"text-muted-foreground"}`,variant:"link",onClick:()=>{i("author",o.member.id)},children:[e.jsxs("div",{className:"relative flex size-5 items-center justify-center overflow-hidden rounded-full bg-accent",children:[o.member.avatar_image&&e.jsx("div",{className:"absolute inset-0",children:e.jsx("img",{src:o.member.avatar_image})}),e.jsx("div",{children:e.jsx(_,{className:"!size-3 text-muted-foreground",size:12})})]}),o.member.name||"Unknown"]})}):e.jsx("span",{className:"block truncate font-semibold",children:o.member?.name||"Unknown"}),e.jsx(E,{className:"text-muted-foreground/50",size:16}),e.jsxs("div",{className:"flex flex-wrap items-baseline gap-1 text-muted-foreground",children:[o.created_at&&e.jsx(N,{children:e.jsxs(C,{children:[e.jsx(k,{asChild:!0,children:e.jsx("span",{className:"cursor-default text-sm text-muted-foreground",children:X(o.created_at)})}),e.jsx(y,{children:Xe(o.created_at)})]})}),e.jsx("span",{children:"on"}),o.post?.id&&o.post?.title&&i?e.jsx(j,{className:"block h-auto truncate p-0 font-medium  text-primary hover:opacity-70",variant:"link",onClick:()=>i("post",o.post.id),children:o.post.title}):e.jsx("span",{className:"text-muted-foreground",children:"Unknown post"})]}),o.status==="hidden"&&e.jsxs(e.Fragment,{children:[e.jsx(E,{className:"text-muted-foreground/50",size:16}),e.jsx("div",{className:"mr-2 flex items-center gap-1 text-muted-foreground",children:"Hidden from members"})]})]}),e.jsx(Ke,{item:o}),e.jsxs("div",{className:"flex flex-row flex-nowrap items-center gap-2",children:[o.status==="published"&&e.jsxs(j,{size:"sm",variant:"outline",onClick:()=>g({id:o.id}),children:[e.jsx(Ce,{}),"Hide"]}),o.status==="hidden"&&e.jsxs(j,{size:"sm",variant:"outline",onClick:()=>v({id:o.id}),children:[e.jsx(ke,{}),"Show"]}),e.jsxs("div",{className:"ml-4 flex items-center gap-3",children:[e.jsx(N,{children:e.jsxs(C,{children:[e.jsx(k,{asChild:!0,children:e.jsxs("div",{className:`ml-2 flex items-center gap-1 text-xs ${!o.count?.replies&&"text-muted-foreground/70"}`,children:[e.jsx(Me,{size:16,strokeWidth:1.5}),e.jsx("span",{children:S(o.count?.replies)})]})}),e.jsx(y,{children:"Replies"})]})}),e.jsx(N,{children:e.jsxs(C,{children:[e.jsx(k,{asChild:!0,children:e.jsxs("div",{className:`ml-2 flex items-center gap-1 text-xs ${!o.count?.likes&&"text-muted-foreground/70"}`,children:[e.jsx(Y,{size:16,strokeWidth:1.5}),e.jsx("span",{children:S(o.count?.likes)})]})}),e.jsx(y,{children:"Likes"})]})}),e.jsx(N,{children:e.jsxs(C,{children:[e.jsx(k,{asChild:!0,children:e.jsxs("div",{className:`ml-2 flex items-center gap-1 text-xs ${o.count?.reports?"font-medium text-yellow-600 dark:text-yellow":"text-muted-foreground/70"}`,children:[e.jsx(K,{size:16,strokeWidth:o.count?.reports?1.75:1.5}),e.jsx("span",{children:S(o.count?.reports)})]})}),e.jsx(y,{children:"Reports"})]})})]}),e.jsxs(Z,{children:[e.jsx(G,{asChild:!0,children:e.jsx(j,{className:"relative z-10 ml-1",size:"sm",variant:"ghost",children:e.jsx(J,{})})}),e.jsxs(ee,{align:"start",children:[o.post?.url&&e.jsx(R,{asChild:!0,children:e.jsxs("a",{href:o.post.url,rel:"noopener noreferrer",target:"_blank",children:[e.jsx(se,{className:"mr-2 size-4"}),"View post"]})}),o.member?.id&&e.jsx(R,{asChild:!0,children:e.jsxs("a",{href:`#/members/${o.member.id}`,children:[e.jsx(_,{className:"mr-2 size-4"}),"View member"]})})]})]})]})]})}),e.jsx(P,{className:"col-start-2 col-end-2 row-start-2 row-end-3 p-0 text-right align-top md:col-start-3 md:col-end-3 lg:table-cell lg:p-4",children:o.post?.feature_image?e.jsx("img",{alt:o.post.title||"Post feature image",className:"hidden aspect-video w-32 rounded object-cover lg:block",src:o.post.feature_image}):null})]},b)),e.jsx(H,{height:h})]})]}),e.jsx(te,{open:!!x,onOpenChange:b=>!b&&u(null),children:e.jsxs(ae,{children:[e.jsxs(re,{children:[e.jsx(ne,{children:"Delete comment?"}),e.jsx(oe,{children:"This comment will be permanently deleted and cannot be recovered."})]}),e.jsxs(le,{children:[e.jsx(ie,{children:"Cancel"}),e.jsx(ce,{className:"hover:bg-red-700 bg-red-600 text-white",onClick:w,children:"Delete"})]})]})})]})}const U=["status","created_at","body","post","author","reported"];function Ge(a){const s=[];for(const t of a)if(t.values[0])switch(t.field){case"status":s.push(`status:${t.values[0]}`);break;case"created_at":if(t.operator==="before"&&t.values[0])s.push(`created_at:<'${t.values[0]}'`);else if(t.operator==="after"&&t.values[0])s.push(`created_at:>'${t.values[0]}'`);else if(t.operator==="is"&&t.values[0]){const i=String(t.values[0]),d=new Date(i+"T00:00:00").toISOString(),l=new Date(i+"T23:59:59.999").toISOString();s.push(`created_at:>='${d}'+created_at:<='${l}'`)}break;case"body":const n=t.values[0].replace(/'/g,"\\'");t.operator==="contains"?s.push(`html:~'${n}'`):t.operator==="not_contains"&&s.push(`html:-~'${n}'`);break;case"post":t.operator==="is_not"?s.push(`post_id:-${t.values[0]}`):s.push(`post_id:${t.values[0]}`);break;case"author":t.operator==="is_not"?s.push(`member_id:-${t.values[0]}`):s.push(`member_id:${t.values[0]}`);break;case"reported":t.values[0]==="true"?s.push("count.reports:>0"):t.values[0]==="false"&&s.push("count.reports:0");break}return s.length?s.join("+"):void 0}function Je(a){if(!a)return null;const s=a.indexOf(":");return s<=0?null:{operator:a.substring(0,s),value:a.substring(s+1)}}function es(a){const s=[];for(const t of U){const r=a.get(t);if(!r)continue;const n=Je(r);n&&s.push({id:t,field:t,operator:n.operator,values:[n.value]})}return s}function ss(a){const s=new URLSearchParams;for(const t of a)if(U.includes(t.field)&&t.values[0]!==void 0){const r=`${t.operator}:${String(t.values[0])}`;s.set(t.field,r)}return s}function ts(){const[a,s]=ue(),t=c.useMemo(()=>es(a),[a]),r=c.useCallback((d,l={})=>{const m=typeof d=="function"?d(t):d,p=ss(m),h=l.replace??!0;s(p,{replace:h})},[t,s]),n=c.useCallback(()=>{s(new URLSearchParams,{replace:!0})},[s]),i=c.useMemo(()=>Ge(t),[t]);return{filters:t,nql:i,setFilters:r,clearFilters:n}}function as({comments:a}){return c.useMemo(()=>{const s=new Map,t=new Map;for(const r of a)r.post?.id&&r.post?.title&&s.set(r.post.id,{id:r.post.id,title:r.post.title}),r.member?.id&&t.set(r.member.id,{id:r.member.id,name:r.member.name,email:r.member.email});return{knownPosts:Array.from(s.values()),knownMembers:Array.from(t.values())}},[a])}const ps=()=>{const{filters:a,nql:s,setFilters:t}=ts(),r=c.useCallback((v,f,x="is")=>{t(u=>[...u.filter(b=>b.field!==v),fe(v,x,[f])],{replace:!1})},[t]),{data:n,isError:i,isFetching:d,isFetchingNextPage:l,fetchNextPage:m,hasNextPage:p}=Oe({searchParams:s?{filter:s}:{},keepPreviousData:!0}),{knownPosts:h,knownMembers:g}=as({comments:n?.comments??[]});return e.jsxs(He,{children:[e.jsx(Le,{children:e.jsx(Ie,{filters:a,knownMembers:g,knownPosts:h,onFiltersChange:t})}),e.jsx(Ee,{children:d&&!l?e.jsx("div",{className:"flex h-full items-center justify-center",children:e.jsx(me,{size:"lg"})}):i?e.jsxs("div",{className:"mb-16 flex h-full flex-col items-center justify-center",children:[e.jsx("h2",{className:"mb-2 text-xl font-medium",children:"Error loading comments"}),e.jsx("p",{className:"mb-4 text-muted-foreground",children:"Please reload the page to try again"}),e.jsx(j,{onClick:()=>window.location.reload(),children:"Reload page"})]}):n?.comments.length?e.jsx(Ze,{fetchNextPage:m,hasNextPage:p,isFetchingNextPage:l,isLoading:d&&!l,items:n?.comments??[],totalItems:n?.meta?.pagination?.total??0,onAddFilter:r}):e.jsx("div",{className:"flex h-full items-center justify-center",children:e.jsx(Re,{title:"No comments yet",children:e.jsx(he,{})})})})]})};export{ps as default};
