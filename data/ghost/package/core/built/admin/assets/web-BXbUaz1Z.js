import{aR as le,j as e,aW as ve,ap as Ce,B as ne,b5 as Ne,aY as _e,b6 as Z,aP as Le,aO as Ee,bJ as Fe,bK as ye,bL as Pe,bM as De,bN as Te,bO as Ae,b$ as Ie,aj as ke,ai as Oe,r as l,c0 as Me,aQ as ae,bS as we,af as ce,ag as Q,c1 as Ue,bR as Re,aM as Ve,u as Be,aS as ze,aN as $e}from"./index-DQyPmpGB.js";import{A as oe,a as p,u as $,S as ue,b as de,U as me}from"./post-analytics-context-GIqnlcrL.js";import{S as Ke,a as Ge,b as We,c as He,d as Qe,e as Ye,f as qe}from"./select-CEu-ZfzV.js";import{a as Je,F as Xe,b as Ze,c as et}from"./message-square-text-C7V7BkDm.js";import{g as tt,a as st,S as at,b as nt}from"./kpis-DlZAT2bv.js";import{F as ot,c as q,e as pe}from"./en-BGQmWTkJ.js";import{C as he,a as it,b as rt,h as lt,c as ge,i as ct,u as W,j as ee}from"./pagemenu-2J5EsqNd.js";import{D as ut,h as dt,i as ie,a as mt,b as pt,c as ht,d as gt,e as ft,f as bt,g as xt}from"./data-list-Hm2fpZku.js";import{a as jt,U as St}from"./wallet-cards-CJX4qjzs.js";import{P as vt,a as Ct}from"./post-analytics-header-kBkBS04F.js";import{F as Nt,c as _t}from"./filters-De2XhgpZ.js";import{b as Lt,c as Et,d as Ft,S as yt,T as Pt}from"./lucide-react-C6c1xSTE.js";import{E as Dt}from"./empty-indicator-CYjCOvfy.js";import"./posts-C7K9oIZ5.js";import"./source-icon-BtbiQT0l.js";import"./source-utils-B1S3ZHA2.js";import"./gh-chart-DG-gbkHv.js";import"./chart-BtaWHe7b.js";import"./_baseAssignValue-ImTGDFcZ.js";import"./tabs-CVQ7aimC.js";import"./index-C_lxe0H8.js";import"./post-share-modal-DSLe_tJv.js";import"./post-helpers-gInwAwEv.js";import"./trash-Jdu7sKoJ.js";import"./sprout-BHEQ3DeZ.js";import"./a-large-small-f8xnoB_N.js";import"./at-sign-DUdEmRQR.js";import"./copy-Bw8gMMdK.js";import"./hash-PFOEsGbs.js";import"./inbox-C1VV1YxX.js";import"./minus-tKuPyWK9.js";import"./tags-DeAucoMX.js";import"./square-CwuHAXtO.js";import"./user-round-check-CP0ms9Dv.js";import"./repeat-BwHSJqPl.js";import"./reply-BxReOZlh.js";const H=[{name:"Public visitors",value:"undefined",bit:p.PUBLIC},{name:"Free members",value:"free",bit:p.FREE},{name:"Paid members",value:"paid",bit:p.PAID}],fe=t=>!t||t.length===0?oe:H.filter(s=>t.includes(s.value)).reduce((s,a)=>s|a.bit,0)||oe,be=t=>{const s=[];return(t&p.PUBLIC)!==0&&s.push(H[0].value),(t&p.FREE)!==0&&s.push(H[1].value),(t&p.PAID)!==0&&s.push(H[2].value),s.join(",")},Tt=()=>{const{audience:t,setAudience:s}=$(),{appSettings:a}=le(),i=o=>{s(t^o)},n=o=>(t&o)!==0,c=(o,m)=>{o.preventDefault(),i(m)},u=()=>{const o=[];if(n(p.PUBLIC)&&o.push("Public visitors"),n(p.FREE)&&o.push("Free members"),!a?.paidMembersEnabled){if(o.length===2)return"All audiences";if(o.length===1)return n(p.FREE)?"Free members":"Public visitors";if(o.length===0)return"Select audience"}return n(p.PAID)&&o.push("Paid members"),o.length===0?"Select audience":o.length===3?"All audiences":n(p.FREE)&&n(p.PAID)&&!n(p.PUBLIC)?"Members-only":o.join(" & ")};return e.jsxs(ve,{children:[e.jsx(Ce,{asChild:!0,children:e.jsxs(ne,{variant:"dropdown",children:[e.jsx(Ne,{}),e.jsx("span",{className:"lowercase first-letter:capitalize",children:u()})]})}),e.jsxs(_e,{align:"end",className:"w-full min-w-48",children:[e.jsx(Z,{checked:n(p.PUBLIC),onSelect:o=>c(o,p.PUBLIC),children:"Public visitors"}),e.jsx(Z,{checked:n(p.FREE),onSelect:o=>c(o,p.FREE),children:"Free members"}),a?.paidMembersEnabled&&e.jsx(Z,{checked:n(p.PAID),onSelect:o=>c(o,p.PAID),children:"Paid members"})]})]})},te=()=>{const{range:t,setRange:s}=$();return e.jsxs(Ke,{value:`${t}`,onValueChange:a=>{s(Number(a))},children:[e.jsxs(Ge,{className:"w-auto",children:[e.jsx(Je,{className:"mr-2",size:16,strokeWidth:1.5}),e.jsx(We,{placeholder:"Select a period"})]}),e.jsx(He,{align:"end",children:e.jsxs(Qe,{children:[e.jsx(Ye,{children:"Period"}),Object.values(ue).map(a=>e.jsx(qe,{value:`${a.value}`,children:a.name},a.value))]})})]})};q.registerLocale(pe);const At=t=>de[t]||q.getName(t,"en")||"Unknown",It=t=>{const s={"UNITED STATES":"US","UNITED STATES OF AMERICA":"US",USA:"US","UNITED KINGDOM":"GB",UK:"GB","GREAT BRITAIN":"GB",NETHERLANDS:"NL"},a=t.toUpperCase();return s[a]||(t.length>2?t.substring(0,2):t)},re=({tableHeader:t,data:s,onLocationClick:a})=>e.jsxs(ut,{children:[t&&e.jsxs(dt,{children:[e.jsx(ie,{children:"Country"}),e.jsx(ie,{children:"Visitors"})]}),e.jsx(mt,{children:s.map(i=>{const n=At(`${i.location}`),c=a&&i.location!=="Unknown",u=i.location?i.location.toLowerCase():"unknown";return e.jsxs(pt,{className:c?"cursor-pointer":"","data-testid":`location-row-${u}`,onClick:c?()=>a(i.location):void 0,children:[e.jsx(ht,{style:{width:`${i.percentage?Math.round(i.percentage*100):0}%`}}),e.jsx(gt,{className:"group-hover/data:max-w-[calc(100%-140px)]",children:e.jsxs("div",{className:"flex items-center space-x-3 overflow-hidden",title:n,children:[e.jsx(ot,{countryCode:`${It(i.location)}`,fallback:e.jsx("span",{className:"flex h-[14px] w-[22px] items-center justify-center rounded-[2px] bg-black text-white",children:e.jsx(Ie.SkullAndBones,{className:"size-3"})})}),e.jsx("div",{className:"truncate font-medium",children:n})]})}),e.jsxs(ft,{children:[e.jsx(bt,{children:ke(Number(i.visits))}),e.jsx(xt,{children:Oe(i.percentage)})]})]},i.location||"unknown")})})]}),kt=({data:t,isLoading:s,onLocationClick:a})=>{const i=t.slice(0,10);return e.jsx(e.Fragment,{children:s?"":e.jsx(e.Fragment,{children:t&&t.length>0&&e.jsxs(he,{className:"group/datalist","data-testid":"locations-card",children:[e.jsxs("div",{className:"flex items-center justify-between p-6",children:[e.jsxs(it,{className:"p-0",children:[e.jsx(rt,{children:"Locations"}),e.jsx(lt,{children:"Where are the readers of this post"})]}),e.jsx(Le,{className:"mr-2",children:"Visitors"})]}),e.jsxs(ge,{className:"overflow-hidden",children:[e.jsx(Ee,{}),e.jsx(re,{data:i,tableHeader:!1,onLocationClick:a})]}),t.length>10&&e.jsx(ct,{children:e.jsxs(Fe,{children:[e.jsx(ye,{asChild:!0,children:e.jsxs(ne,{variant:"outline",children:["View all ",e.jsx(jt,{})]})}),e.jsxs(Pe,{className:"overflow-y-auto pt-0 sm:max-w-[600px]",children:[e.jsxs(De,{className:"sticky top-0 z-40 -mx-6 bg-background/60 p-6 backdrop-blur",children:[e.jsx(Te,{children:"Top locations"}),e.jsx(Ae,{children:"Where are the readers of this post"})]}),e.jsx("div",{className:"group/datalist",children:e.jsx(re,{data:t,tableHeader:!0,onLocationClick:a})})]})]})})]})})})};q.registerLocale(pe);const Ot=t=>de[t]||q.getName(t,"en")||t,Mt=({visits:t})=>e.jsx("span",{className:"order-2 font-mono text-xs text-muted-foreground",children:t.toLocaleString()}),wt={utm_source:{endpoint:"api_top_utm_sources",valueKey:"utm_source",transformValue:t=>({value:t||"(not set)",label:t||"(not set)"})},utm_medium:{endpoint:"api_top_utm_mediums",valueKey:"utm_medium",transformValue:t=>({value:t||"(not set)",label:t||"(not set)"})},utm_campaign:{endpoint:"api_top_utm_campaigns",valueKey:"utm_campaign",transformValue:t=>({value:t||"(not set)",label:t||"(not set)"})},utm_content:{endpoint:"api_top_utm_contents",valueKey:"utm_content",transformValue:t=>({value:t||"(not set)",label:t||"(not set)"})},utm_term:{endpoint:"api_top_utm_terms",valueKey:"utm_term",transformValue:t=>({value:t||"(not set)",label:t||"(not set)"})},source:{endpoint:"api_top_sources",valueKey:"source",transformValue:t=>({value:t||"",label:t||"Direct"})},location:{endpoint:"api_top_locations",valueKey:"location",filterItem(t){const s=String(t.location||"");return s!==""&&!me.includes(s)},transformValue:t=>({value:t,label:Ot(t)})},device:{endpoint:"api_top_devices",valueKey:"device",transformValue:t=>({value:t,label:t==="mobile-ios"?"iOS":t==="mobile-android"?"Android":t==="desktop"?"Desktop":t==="bot"?"Bot":t})}},Ut=(t,s,a)=>{const i={...a};return t.forEach(n=>{if(n.field===s||n.values.length===0)return;const c=n.values[0];n.field!=="audience"&&(n.field==="source"||n.field==="device"||n.field==="location"||n.field.startsWith("utm_"))&&(i[n.field]=c)}),i},P=(t,s=[],a,i={})=>{const{enabled:n=!0}=i,{statsConfig:c,range:u}=$(),{startDate:o,endDate:m,timezone:b}=ce(u),h=wt[t],f=l.useMemo(()=>{const N=s.find(v=>v.field==="audience");return fe(N?.values)},[s]),g=l.useMemo(()=>{const N={site_uuid:c?.id||"",date_from:Q(o),date_to:Q(m),timezone:b,member_status:be(f),limit:"50"};return a&&(N.post_uuid=a),Ut(s,t,N)},[c?.id,o,m,b,f,s,t,a]),{data:C,loading:D}=W({endpoint:h?.endpoint||"",statsConfig:c,params:g,enabled:n&&!!h});return{options:l.useMemo(()=>h?(C||[]).filter(v=>h.filterItem?h.filterItem(v):!0).map(v=>{const F=String(v[h.valueKey]??""),y=Number(v.visits)||0,{value:w,label:U}=h.transformValue?h.transformValue(F):{value:F,label:F};return{label:U,value:w,icon:e.jsx(Mt,{visits:y})}}):[],[C,h]),loading:D}};function Rt({filters:t,utmTrackingEnabled:s=!1,onChange:a,...i}){const{appSettings:n}=le(),{post:c}=$(),u=c?.uuid,[o,m]=l.useState(null),[b,h]=l.useState(!1);l.useEffect(()=>{const j=window.matchMedia("(max-width: 1024px)"),_=k=>{h(k.matches)};return _(j),j.addEventListener("change",_),()=>j.removeEventListener("change",_)},[]);const f=l.useMemo(()=>{const j=[{value:"undefined",label:"Public visitors",icon:e.jsx(ae,{className:"text-gray-700"})},{value:"free",label:"Free members",icon:e.jsx(we,{className:"text-green"})},{value:"paid",label:"Paid members",icon:e.jsx(St,{className:"text-orange"})}];return n?.paidMembersEnabled?j:j.filter(_=>_.value!=="paid")},[n?.paidMembersEnabled]),g=l.useCallback(j=>{const _=o===j,k=t.some(O=>O.field===j);return _||k},[o,t]),{options:C,loading:D}=P("utm_source",t,u,{enabled:g("utm_source")}),{options:M,loading:N}=P("utm_medium",t,u,{enabled:g("utm_medium")}),{options:v,loading:F}=P("utm_campaign",t,u,{enabled:g("utm_campaign")}),{options:y,loading:w}=P("utm_content",t,u,{enabled:g("utm_content")}),{options:U,loading:R}=P("utm_term",t,u,{enabled:g("utm_term")}),{options:T,loading:K}=P("source",t,u,{enabled:g("source")}),{options:A,loading:B}=P("device",t,u,{enabled:g("device")}),{options:I,loading:G}=P("location",t,u,{enabled:g("location")}),x=l.useMemo(()=>[{value:"is",label:"is"}],[]),J=l.useMemo(()=>{const j=s?[{key:"utm_source",label:"UTM Source",type:"select",icon:e.jsx(Ft,{className:"size-4"}),placeholder:"Select source",operators:x,defaultOperator:"is",hideOperatorSelect:!0,options:C,isLoading:D,searchable:!0,selectedOptionsClassName:"hidden"},{key:"utm_medium",label:"UTM Medium",type:"select",icon:e.jsx(yt,{className:"size-4"}),placeholder:"Select medium",operators:x,defaultOperator:"is",hideOperatorSelect:!0,options:M,isLoading:N,className:"w-60",popoverContentClassName:"w-60",searchable:!0,selectedOptionsClassName:"hidden"},{key:"utm_campaign",label:"UTM Campaign",type:"select",icon:e.jsx(et,{className:"size-4"}),placeholder:"Select campaign",operators:x,defaultOperator:"is",hideOperatorSelect:!0,options:v,isLoading:F,className:"w-60",popoverContentClassName:"w-60",searchable:!0,selectedOptionsClassName:"hidden"},{key:"utm_content",label:"UTM Content",type:"select",icon:e.jsx(Pt,{className:"size-4"}),placeholder:"Select content",operators:x,defaultOperator:"is",hideOperatorSelect:!0,options:y,isLoading:w,className:"w-60",popoverContentClassName:"w-60",searchable:!0,selectedOptionsClassName:"hidden"},{key:"utm_term",label:"UTM Term",type:"select",icon:e.jsx(Ue,{className:"size-4"}),placeholder:"Select term",operators:x,defaultOperator:"is",hideOperatorSelect:!0,options:U,isLoading:R,className:"w-60",popoverContentClassName:"w-60",searchable:!0,selectedOptionsClassName:"hidden"}]:[];return[{group:"Basic",fields:[{key:"audience",label:"Audience",type:"multiselect",icon:e.jsx(Me,{}),options:f.map(({value:_,label:k,icon:O})=>({value:_,label:k,icon:O})),defaultOperator:"is any of",hideOperatorSelect:!0,autoCloseOnSelect:!0},{key:"source",label:"Source",type:"select",icon:e.jsx(ae,{className:"size-4"}),placeholder:"Select source",operators:x,defaultOperator:"is",hideOperatorSelect:!0,options:T,isLoading:K,className:"w-60",popoverContentClassName:"w-60",searchable:!0,selectedOptionsClassName:"hidden"},{key:"device",label:"Device",type:"select",icon:e.jsx(Lt,{className:"size-4"}),placeholder:"Select device",operators:x,defaultOperator:"is",hideOperatorSelect:!0,options:A,isLoading:B,selectedOptionsClassName:"hidden"},{key:"location",label:"Location",type:"select",icon:e.jsx(Et,{className:"size-4"}),placeholder:"Select location",operators:x,defaultOperator:"is",hideOperatorSelect:!0,options:I,isLoading:G,searchable:!0,selectedOptionsClassName:"hidden"}]},...s?[{group:"UTM parameters",fields:j}]:[]]},[s,C,D,M,N,v,F,y,w,U,R,x,f,T,K,A,B,I,G]),V=t.length>0,X=l.useCallback(()=>{a&&a([])},[a]);return e.jsxs("div",{className:"mt-3 flex w-full justify-between gap-2 lg:mt-0","data-testid":"stats-filter-container",children:[e.jsx(Nt,{addButtonIcon:e.jsx(Xe,{}),addButtonText:V?"Add filter":"Filter",allowMultiple:!1,className:`[&>button]:order-last ${V&&"[&>button]:border-none"}`,fields:J,filters:t,keyboardShortcut:"f",popoverAlign:b||V?"start":"end",showSearchInput:!1,onActiveFieldChange:m,onChange:a||(()=>{}),...i}),V&&e.jsxs(ne,{className:"hidden font-normal text-muted-foreground lg:flex","data-testid":"stats-filter-clear-button",variant:"ghost",onClick:X,children:[e.jsx(Ze,{}),"Clear"]})]})}const Y=["audience","source","device","location","utm_source","utm_medium","utm_campaign","utm_content","utm_term"],xe="__empty__",je="%2C";function Vt(t){const s=new URLSearchParams;return t.forEach(a=>{if(Y.includes(a.field)&&a.values.length>0){const i=a.values.map(n=>n===""?xe:String(n).replace(/,/g,je)).join(",");s.set(a.field,i)}}),s}const se=new Map;function Bt(t){return se.has(t)||se.set(t,`url-${t}-${Date.now()}-${Math.random().toString(36).substring(2,11)}`),se.get(t)}function zt(t){const s=[],a=new Set(Y);return t.forEach((i,n)=>{if(!a.has(n))return;const c=i.split(",").map(u=>u===xe?"":u.replace(new RegExp(je,"g"),","));if(c.length>0){const u=n==="audience"?"is any of":"is";s.push({id:Bt(n),field:n,operator:u,values:c})}}),s}function $t(t={}){const[s,a]=Re(),{onFiltersChange:i}=t,n=l.useRef(!1),c=l.useMemo(()=>zt(s),[s]);l.useEffect(()=>{!n.current&&i&&i(c)},[c,i]);const u=l.useCallback(m=>{n.current=!0;const b=typeof m=="function"?m(c):m,h=Vt(b),f=new URLSearchParams(s);Y.forEach(g=>{f.delete(g)}),h.forEach((g,C)=>{f.set(C,g)}),a(f,{replace:!0}),setTimeout(()=>{n.current=!1},0)},[c,s,a]),o=l.useCallback(()=>{n.current=!0;const m=new URLSearchParams(s);Y.forEach(b=>{m.delete(b)}),a(m,{replace:!0}),setTimeout(()=>{n.current=!1},0)},[s,a]);return{filters:c,setFilters:u,clearFilters:o}}const Es=()=>{const t=Ve(),{postId:s}=Be(),{statsConfig:a,isLoading:i,range:n,audience:c,data:u,post:o,isPostLoading:m}=$(),{filters:b,setFilters:h}=$t(),f=u?.labs?.utmTracking||!1,g=l.useMemo(()=>{if(!f)return c;const r=b.find(S=>S.field==="audience");return fe(r?.values)},[f,c,b]);l.useEffect(()=>{!m&&o?.email_only&&t(`/posts/analytics/${s}`)},[m,o?.email_only,t,s]);const C=l.useMemo(()=>{if(!o?.published_at)return ue.ALL_TIME.value;const r=ze(o.published_at);return n>r?r:n},[o?.published_at,n]),{startDate:D,endDate:M,timezone:N}=ce(C),v=l.useCallback(()=>{const r=document.querySelector(".overflow-y-scroll");r&&r.scrollTo({top:0,behavior:"smooth"})},[]),F=l.useMemo(()=>{const r={};return b.forEach(S=>{const L=S.field,E=S.values;if(L==="audience")return;const d=E&&E.length>0&&E[0]!==null&&E[0]!==void 0,z=L==="source"&&E?.[0]==="";if(d&&(E[0]!==""||z)){const Se=String(E[0]);r[L]=Se}}),r},[b]),y=l.useCallback((r,S)=>{h(L=>L.find(d=>d.field===r)?L.map(d=>d.field===r?{...d,values:[S]}:d):[...L,_t(r,"is",[S])]),v()},[h,v]),w=l.useCallback(r=>y("location",r),[y]),U=l.useCallback(r=>y("source",r),[y]),R=l.useMemo(()=>{const r={site_uuid:a?.id||"",date_from:Q(D),date_to:Q(M),timezone:N,member_status:be(g),post_uuid:"",...F};return!m&&o?.uuid?{...r,post_uuid:o.uuid}:r},[m,o,a?.id,D,M,N,g,F]),{data:T,loading:K}=W({endpoint:"api_kpis",statsConfig:a||{id:""},params:R}),{data:A,loading:B}=W({endpoint:"api_top_locations",statsConfig:a||{id:""},params:R}),{data:I,loading:G}=W({endpoint:"api_top_sources",statsConfig:a||{id:""},params:R}),x=l.useMemo(()=>A?.reduce((r,S)=>r+Number(S.visits),0)||0,[A]),J=l.useMemo(()=>I?I.reduce((r,S)=>r+Number(S.visits||0),0):0,[I]),V=u?.url,X=u?.icon,j=l.useMemo(()=>{const r=A?.map(d=>({location:String(d.location),visits:Number(d.visits),percentage:x>0?Number(d.visits)/x:0,isUnknown:me.includes(String(d.location))}))||[],S=r.filter(d=>!d.isUnknown),L=r.filter(d=>d.isUnknown),E=L.length>0?[{location:"Unknown",visits:L.reduce((d,z)=>d+z.visits,0),percentage:L.reduce((d,z)=>d+z.percentage,0)}]:[];return[...S,...E]},[A,x]),_=i||m||K||B||G,k=tt(T),O=b.length>0;return e.jsxs(e.Fragment,{children:[e.jsx(vt,{currentTab:"Web",children:f?e.jsxs(e.Fragment,{children:[O&&e.jsx(ee,{children:e.jsx(te,{})}),e.jsxs(ee,{className:`${O?"!mt-0 [grid-area:subactions] lg:!mt-[25px]":"[grid-area:actions]"}`,children:[e.jsx(Rt,{filters:b,utmTrackingEnabled:f,onChange:h}),!O&&e.jsx(te,{})]})]}):e.jsxs(ee,{children:[e.jsx(Tt,{}),e.jsx(te,{})]})}),e.jsx(Ct,{children:_?e.jsx(he,{className:"size-full",variant:"plain",children:e.jsx(ge,{className:"size-full items-center justify-center",children:e.jsx($e,{})})}):T&&T.length!==0&&k.visits!=="0"?e.jsxs(e.Fragment,{children:[e.jsx(st,{data:T,range:C}),e.jsxs("div",{className:"flex flex-col gap-6 lg:grid lg:grid-cols-2",children:[e.jsx(kt,{data:j,isLoading:B,onLocationClick:f?w:void 0}),e.jsx(at,{data:I,range:C,siteIcon:X,siteUrl:V,totalVisitors:J,onSourceClick:f?U:void 0})]})]}):e.jsx("div",{className:"grow",children:e.jsx(Dt,{className:"h-full",description:"Try adjusting filters to see more data.",title:`No visitors ${nt(n)}`,children:e.jsx(ae,{strokeWidth:1.5})})})})]})};export{Es as default};
