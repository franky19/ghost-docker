import{r as c,b3 as U,aM as te,bR as se,b4 as z,aj as T,j as e,aN as ee,ai as w,aW as pe,ap as he,aY as xe,a_ as I,bT as fe,bU as ae,af as X,ag as K,bV as ge,e as Q,bP as be,B as je}from"./index-DQyPmpGB.js";import{s as ve,g as q,S as ke,a as we,D as Ne,b as Se}from"./stats-view-A5TqI_uq.js";import{C as _e,a as ye,R as Ce,B as Te}from"./chart-BtaWHe7b.js";import{E as re}from"./empty-indicator-CYjCOvfy.js";import{G as Me,C as De,X as Le,Y as Re}from"./gh-chart-DG-gbkHv.js";import{T as Be,a as Pe,K as Y,d as B,e as Ee}from"./tabs-CVQ7aimC.js";import{B as Oe,S as $}from"./sort-button-CDDZp_Us.js";import{M as le}from"./wallet-cards-CJX4qjzs.js";import{S as Ae,a as Ve,b as We,c as $e,d as He,e as Ke,f as ze}from"./select-CEu-ZfzV.js";import{M as Fe}from"./lucide-react-C6c1xSTE.js";import{j as Ge,C as ne,c as oe,a as Ie,b as Ye,h as Ue}from"./pagemenu-2J5EsqNd.js";import{a as Xe,e as Qe,b as qe,c as H,d as E,f as L}from"./table-ezlpPvP1.js";import{u as Je}from"./newsletters-CnOF1I5K.js";import{e as Ze,f as et,g as tt}from"./stats-B1umFX9r.js";import"./message-square-text-C7V7BkDm.js";import"./sprout-BHEQ3DeZ.js";import"./_baseAssignValue-ImTGDFcZ.js";import"./index-C_lxe0H8.js";import"./a-large-small-f8xnoB_N.js";import"./at-sign-DUdEmRQR.js";import"./copy-Bw8gMMdK.js";import"./hash-PFOEsGbs.js";import"./inbox-C1VV1YxX.js";import"./minus-tKuPyWK9.js";import"./tags-DeAucoMX.js";import"./square-CwuHAXtO.js";import"./user-round-check-CP0ms9Dv.js";import"./repeat-BwHSJqPl.js";import"./reply-BxReOZlh.js";import"./trash-Jdu7sKoJ.js";const st=({active:a,payload:s})=>{if(!a||!s?.length)return null;const r=s[0].payload,o=r.send_date;return e.jsxs("div",{className:"min-w-[220px] max-w-[240px] rounded-lg border bg-background px-3 py-2 shadow-lg",children:[e.jsxs("div",{className:"mb-2 flex w-full flex-col border-b pb-2",children:[e.jsx("span",{className:"text-sm font-semibold leading-tight",children:r.post_title}),e.jsxs("span",{className:"text-sm text-muted-foreground",children:["Sent on ",ae(o)]})]}),e.jsxs("div",{className:"mb-1 flex w-full justify-between",children:[e.jsx("span",{className:"font-medium text-muted-foreground",children:"Sent"}),e.jsx("div",{className:"ml-2 w-full text-right font-mono",children:T(r.sent_to)})]}),e.jsxs("div",{className:"mb-1 flex w-full justify-between",children:[e.jsx("span",{className:"font-medium text-muted-foreground",children:"Opens"}),e.jsxs("div",{className:"ml-2 w-full text-right font-mono",children:[e.jsxs("span",{className:"text-muted-foreground",children:[T(r.total_opens)," / "]}),w(r.open_rate)]})]}),e.jsxs("div",{className:"mb-1 flex w-full justify-between",children:[e.jsx("span",{className:"font-medium text-muted-foreground",children:"Clicks"}),e.jsxs("div",{className:"ml-2 w-full text-right font-mono",children:[e.jsxs("span",{className:"text-muted-foreground",children:[T(r.total_clicks)," / "]}),w(r.click_rate)]})]})]})},at=({subscribersData:a,avgsData:s,totals:r,isLoading:o,isAvgsLoading:t,initialTab:n="total-subscribers"})=>{const[l,h]=c.useState(n),[p,g]=c.useState(!1),{range:d}=U(),N=te(),[j]=se(),{appSettings:y}=z(),{emailTrackClicks:k,emailTrackOpens:u}=y?.analytics||{},{totalSubscribers:O,avgOpenRate:D,avgClickRate:m}=r,f=c.useMemo(()=>{if(!a||a.length===0)return[];let i=[];return i=ve(a,d,"value","exact"),i.map(M=>({...M,formattedValue:T(M.value),label:"Total Subscribers"}))},[a,d]),S=c.useMemo(()=>{if(!f||f.length<=1)return{direction:"same",value:"0%"};const i=f[0]?.value??0,v=f[f.length-1]?.value??0;let M="same";v>i?M="up":v<i&&(M="down");let P;if(i===0)P=v===0?"0%":"+100%";else{const A=(v-i)/i*100,V=Math.round(A*10)/10;P=`${A>=0?"+":""}${V}%`}return{direction:M,value:P}},[f]);c.useEffect(()=>{h(n)},[n]);const x=i=>{h(i);const v=new URLSearchParams(j);v.set("tab",i),N(`?${v.toString()}`,{replace:!0})},_={open_rate:{label:"Open rate"}},b=c.useMemo(()=>({"total-subscribers":{color:"hsl(var(--chart-darkblue))",datakey:"value"},"avg-open-rate":{color:"hsl(var(--chart-blue))",datakey:"open_rate"},"avg-click-rate":{color:"hsl(var(--chart-teal))",datakey:"click_rate"}}),[]),{barDomain:C,barTicks:R}=c.useMemo(()=>{if(!s||s.length===0||l==="total-subscribers")return{barDomain:[0,1],barTicks:[0,1]};const i=b[l]?.datakey;if(!i)return{barDomain:[0,1],barTicks:[0,1]};const v=s.map(G=>G[i]).filter(G=>typeof G=="number");if(v.length===0)return{barDomain:[0,1],barTicks:[0,1]};const M=Math.min(...v),P=Math.max(...v),A=Math.floor(M*10)/10,V=Math.ceil(P*10)/10,W=Math.max(0,A),Z=V===W?W+.1:V;return{barDomain:[W,Z],barTicks:[W,Z]}},[s,l,b]);if(o)return e.jsx("div",{className:"-mb-6 flex h-[calc(16vw+132px)] w-full items-start justify-center",children:e.jsx(ee,{})});let F="grid-cols-3";(!k||!u)&&(F="grid-cols-2"),!k&&!u&&(F="grid-cols-1");const ue=l==="avg-open-rate"&&D>C[0]&&D<C[1]||l==="avg-click-rate"&&m>C[0]&&m<C[1],J=l==="avg-open-rate"?D:m;return e.jsxs(Be,{defaultValue:n,variant:"kpis",children:[e.jsxs(Pe,{className:`-mx-6 hidden grid-cols-3 md:!visible md:!grid ${F}`,children:[e.jsx(Y,{className:`${!u&&!k&&"cursor-auto after:hidden"}`,value:"total-subscribers",onClick:()=>{x("total-subscribers")},children:e.jsx(B,{color:b["total-subscribers"].color,"data-testid":"total-subscribers-value",diffDirection:S.direction,diffValue:S.value,label:"Total subscribers",value:T(O)})}),u&&e.jsx(Y,{value:"avg-open-rate",onClick:()=>{x("avg-open-rate")},children:e.jsx(B,{className:t?"opacity-50":"",color:b["avg-open-rate"].color,label:"Avg. open rate",value:w(D)})}),k&&e.jsx(Y,{value:"avg-click-rate",onClick:()=>{x("avg-click-rate")},children:e.jsx(B,{className:t?"opacity-50":"",color:b["avg-click-rate"].color,label:"Avg. click rate",value:w(m)})})]}),e.jsxs(pe,{children:[e.jsx(he,{className:"md:hidden",asChild:!0,children:e.jsxs(Ee,{children:[l==="total-subscribers"&&e.jsx(B,{color:b["total-subscribers"].color,label:"Total subscribers",value:T(O)}),l==="avg-open-rate"&&u&&e.jsx(B,{className:t?"opacity-50":"",color:b["avg-open-rate"].color,label:"Avg. open rate",value:w(D)}),l==="avg-click-rate"&&k&&e.jsx(B,{className:t?"opacity-50":"",color:b["avg-click-rate"].color,label:"Avg. click rate",value:w(m)})]})}),e.jsxs(xe,{align:"end",className:"w-56",children:[e.jsx(I,{onClick:()=>x("total-subscribers"),children:"Total subscribers"}),u&&e.jsx(I,{onClick:()=>x("avg-open-rate"),children:"Avg. open rate"}),k&&e.jsx(I,{onClick:()=>x("avg-click-rate"),children:"Avg. click rate"})]})]}),e.jsxs("div",{className:"my-4 [&_.recharts-cartesian-axis-tick-value]:fill-gray-500",children:[l==="total-subscribers"&&e.jsx(Me,{className:"-mb-3 h-[16vw] max-h-[320px] min-h-[180px] w-full",color:b["total-subscribers"].color,data:f,id:"mrr",range:d}),(l==="avg-open-rate"&&u||l==="avg-click-rate"&&k)&&e.jsx(e.Fragment,{children:t?e.jsx("div",{className:"h-[320px] w-full items-center justify-center",children:e.jsx(ee,{})}):s&&s.length>0?e.jsxs(e.Fragment,{children:[e.jsx(_e,{className:"aspect-auto h-[200px] w-full md:h-[220px] xl:h-[320px]",config:_,children:e.jsxs(Oe,{className:p?"!cursor-pointer":"",data:s,margin:{top:20},onClick:i=>{i.activePayload&&i.activePayload[0].payload.post_id&&N(`/posts/analytics/${i.activePayload[0].payload.post_id}`,{crossApp:!0})},onMouseLeave:()=>g(!1),onMouseMove:i=>{g(!!(i.activePayload&&i.activePayload[0].payload.post_id))},children:[e.jsx("defs",{children:e.jsxs("linearGradient",{id:"barGradient",x1:"0",x2:"0",y1:"0",y2:"1",children:[e.jsx("stop",{offset:"0%",stopColor:b[l].color,stopOpacity:.8}),e.jsx("stop",{offset:"100%",stopColor:b[l].color,stopOpacity:.6})]})}),e.jsx(De,{horizontal:!0,stroke:"hsl(var(--border))",vertical:!1}),e.jsx(Le,{axisLine:{stroke:"hsl(var(--border))",strokeWidth:1},dataKey:"post_id",interval:0,stroke:"hsl(var(--border))",tickFormatter:()=>"",tickLine:!1,tickMargin:10}),e.jsx(Re,{axisLine:!1,domain:C,tickFormatter:i=>w(i),tickLine:!1,ticks:R,width:fe(R,i=>w(i))}),e.jsx(ye,{content:e.jsx(st,{}),cursor:!1,isAnimationActive:!1,position:{y:10}}),ue&&e.jsx(Ce,{label:{value:`${w(J)}`,position:"left",offset:8,fill:"hsl(var(--muted-foreground))"},opacity:.5,stroke:"hsl(var(--muted-foreground))",strokeDasharray:"4 4",y:J}),e.jsx(Te,{activeBar:{fillOpacity:1},dataKey:b[l].datakey,fill:"url(#barGradient)",fillOpacity:.6,isAnimationActive:!1,maxBarSize:32,minPointSize:3,radius:4})]})}),e.jsxs("div",{className:"-mt-4 text-center text-sm text-muted-foreground",children:["Newsletters ",l==="avg-open-rate"?"opens":"clicks"," in this period"]})]}):e.jsx(re,{className:"size-full py-20",title:`No newsletters ${q(d)}`,children:e.jsx(le,{strokeWidth:1.5})})})]})]})},rt=({newsletters:a})=>{const{selectedNewsletterId:s,setSelectedNewsletterId:r}=U(),o=c.useMemo(()=>a?.filter(t=>t.status==="active")||[],[a]);return c.useEffect(()=>{if(o.length>0&&!s){const t=o.find(n=>n.sort_order===0);r(t?t.id:o[0].id)}},[o,s,r]),o.length<=1?null:e.jsxs(Ae,{value:s||"",onValueChange:t=>{r(t)},children:[e.jsxs(Ve,{className:"w-auto",children:[e.jsx(Fe,{className:"mr-2",size:16,strokeWidth:1.5}),e.jsx(We,{placeholder:"Select a newsletter"})]}),e.jsx($e,{align:"end",children:e.jsxs(He,{children:[e.jsx(Ke,{children:"Newsletters"}),o.map(t=>e.jsx(ze,{value:t.id,children:t.name},t.id))]})})]})},lt=(a,s,r=!0)=>{const o=a??30,{startDate:t,endDate:n}=c.useMemo(()=>X(o),[o]),l=c.useMemo(()=>{const p={date_from:K(t),date_to:K(n)};return s&&(p.newsletter_id=s),p},[t,n,s]),h=Ze({searchParams:l,enabled:r});return r?h:{data:void 0,isLoading:!1,error:null,isError:!1,refetch:h.refetch}},nt=(a,s,r,o=!0)=>{const t=a??30,n=s??"date desc",{startDate:l,endDate:h}=c.useMemo(()=>X(t),[t]),p=c.useMemo(()=>{const d={date_from:K(l),date_to:K(h),order:n};return r&&(d.newsletter_id=r),d},[l,h,n,r]),g=et({searchParams:p,enabled:o});return o?g:{data:void 0,isLoading:!1,error:null,isError:!1,refetch:g.refetch}},ot=(a,s=[],r=!0)=>{const o=c.useMemo(()=>{const n={};return a&&(n.newsletter_id=a),s.length>0&&(n.post_ids=s.join(",")),n},[a,s]),t=tt({searchParams:o,enabled:r});return r?t:{data:void 0,isLoading:!1,error:null,isError:!1,refetch:t.refetch}},ie=(a,s,r,o=!0)=>{const t=nt(a,s,r,o),n=c.useMemo(()=>t.data?.stats?t.data.stats.map(p=>p.post_id):[],[t.data]),l=ot(r,n,o&&n.length>0);return{data:c.useMemo(()=>{if(!t.data?.stats)return;const p=t.data.stats,g=l.data?.stats||[],d=new Map;g.forEach(j=>{d.set(j.post_id,j)});const N=p.map(j=>{const y=d.get(j.post_id);return{...j,total_clicks:y?.total_clicks||0,click_rate:y?.click_rate||0}});return{...t.data,stats:N}},[t.data,l.data]),isLoading:t.isLoading,isClicksLoading:l.isLoading,error:t.error||l.error,isError:t.isError||l.isError,refetch:()=>{t.refetch(),l.refetch()}}},ce=Q.memo(({range:a,selectedNewsletterId:s,shouldFetchStats:r,sortBy:o})=>{const t=te(),{data:n,isLoading:l,isClicksLoading:h}=ie(a,o,s||void 0,!!r),{appSettings:p}=z(),{emailTrackClicks:g,emailTrackOpens:d}=p?.analytics||{},N=c.useMemo(()=>n?.stats||[],[n]),j=d&&g?5:d||g?4:3,y=c.useMemo(()=>e.jsx(e.Fragment,{children:e.jsx(H,{className:"last:border-none [&>td]:py-2.5",children:e.jsx(L,{className:"font-medium",colSpan:j,children:e.jsx(be,{className:"mt-5"})})})}),[j]),k=c.useMemo(()=>N.length>0?e.jsx(e.Fragment,{children:N.map(u=>e.jsxs(H,{className:"last:border-none [&>td]:py-2.5",children:[e.jsx(L,{className:"font-medium",children:e.jsx("div",{className:"group/link inline-flex items-center gap-2",children:u.post_id?e.jsx(je,{className:"h-auto whitespace-normal p-0 text-left hover:!underline",title:"View post analytics",variant:"link",onClick:()=>{t(`/posts/analytics/${u.post_id}/`,{crossApp:!0})},children:u.post_title}):e.jsx(e.Fragment,{children:u.post_title})})}),e.jsx(L,{className:"whitespace-nowrap text-sm",children:ae(u.send_date)}),e.jsx(L,{className:"text-right font-mono text-sm",children:T(u.sent_to)}),d&&e.jsxs(L,{className:"text-right font-mono text-sm",children:[e.jsx("span",{className:"group-hover:hidden",children:w(u.open_rate)}),e.jsx("span",{className:"hidden group-hover:!visible group-hover:!block",children:T(u.total_opens)})]}),g&&e.jsx(L,{className:"text-right font-mono text-sm",children:h?e.jsx("span",{className:"inline-block h-4 w-8 animate-pulse rounded bg-gray-200"}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"group-hover:hidden",children:w(u.click_rate)}),e.jsx("span",{className:"hidden group-hover:!visible group-hover:!block",children:T(u.total_clicks)})]})})]},u.post_id))}):e.jsx(H,{className:"border-none hover:bg-transparent",children:e.jsx(L,{className:"text-center group-hover:!bg-transparent",colSpan:5,children:e.jsx(re,{className:"size-full py-20",title:`No newsletters ${q(a)}`,children:e.jsx(le,{strokeWidth:1.5})})})}),[N,h,t,g,d,a]);return l||!n?y:k});ce.displayName="NewsletterTableRows";const de=Q.memo(({sortBy:a,setSortBy:s,range:r})=>{const o=c.useMemo(()=>e.jsxs(Ie,{children:[e.jsx(Ye,{children:"Top newsletters"}),e.jsxs(Ue,{children:[" Your best performing newsletters ",q(r)]})]}),[r]),{appSettings:t}=z(),{emailTrackClicks:n,emailTrackOpens:l}=t?.analytics||{};return e.jsx(qe,{children:e.jsxs(H,{children:[e.jsx(E,{className:"min-w-[320px]",variant:"cardhead",children:o}),e.jsx(E,{className:"w-[65px]",children:e.jsx($,{activeSortBy:a,setSortBy:s,sortBy:"date desc",children:"Date"})}),e.jsx(E,{className:"w-[90px] text-right",children:e.jsx($,{activeSortBy:a,setSortBy:s,sortBy:"sent_to desc",children:"Sent"})}),l&&e.jsx(E,{className:"w-[90px] text-right",children:e.jsx($,{activeSortBy:a,setSortBy:s,sortBy:"open_rate desc",children:"Opens"})}),n&&e.jsx(E,{className:"w-[90px] text-right",children:e.jsx($,{activeSortBy:a,setSortBy:s,sortBy:"click_rate desc",children:"Clicks"})})]})})});de.displayName="NewsletterTableHeader";const me=Q.memo(({range:a,selectedNewsletterId:s,shouldFetchStats:r})=>{const[o,t]=c.useState("open_rate desc");return e.jsx(ne,{className:"w-full max-w-[calc(100vw-64px)] overflow-x-auto sidebar:max-w-[calc(100vw-64px-280px)]","data-testid":"top-newsletters-card",children:e.jsx(oe,{children:e.jsxs(Xe,{children:[e.jsx(de,{range:a,setSortBy:t,sortBy:o}),e.jsx(Qe,{children:e.jsx(ce,{range:a,selectedNewsletterId:s,shouldFetchStats:r,sortBy:o})})]})})})});me.displayName="TopNewslettersTable";const Vt=()=>{const{range:a,selectedNewsletterId:s}=U(),[r]=se(),{appSettings:o}=z(),t=r.get("tab")||"total-subscribers",{data:n,isLoading:l}=Je({searchParams:{limit:"50"}}),h=!l&&n&&n.newsletters.length>0&&!!s,{data:p,isLoading:g}=lt(a,s||void 0,h||!1),{data:d,isLoading:N,isClicksLoading:j}=ie(a,"date asc",s||void 0,h||!1),y=c.useMemo(()=>!n?.newsletters||!s?null:n.newsletters.find(m=>m.id===s)||null,[n,s]),k=c.useMemo(()=>{const m=y?.count?.active_members||p?.stats?.[0]?.total||0;let f=0,S=0;if(d?.stats&&d.stats.length>0){const x=d.stats,_=x.reduce((C,R)=>C+(R.open_rate||0),0),b=x.reduce((C,R)=>C+(R.click_rate||0),0);f=_/x.length,S=b/x.length}return{totalSubscribers:m,avgOpenRate:f,avgClickRate:S}},[y,p,d]),u=c.useMemo(()=>{if(!p?.stats?.[0]?.values||p.stats[0].values.length===0){const{startDate:f,endDate:S}=X(a),x=[],_=new Date(f);for(;_<=S;)x.push({date:_.toISOString().split("T")[0],value:0}),_.setDate(_.getDate()+1);return x}const m=p.stats[0].values;if(m.length===1){const f=m[0],S=new Date,x=a,_=new Date(S.getTime()-x*24*60*60*1e3);return[{...f,date:_.toISOString().split("T")[0]},{...f,date:S.toISOString().split("T")[0]}]}return m},[p,a]),O=c.useMemo(()=>d?.stats?d.stats.map(m=>({post_id:m.post_id,post_title:m.post_title,send_date:m.send_date,sent_to:m.sent_to,total_opens:m.total_opens,open_rate:m.open_rate,total_clicks:m.total_clicks||0,click_rate:m.click_rate||0})):[],[d]),D=g||j||N;return o?.newslettersEnabled?e.jsxs(ke,{children:[e.jsx(we,{children:e.jsxs(Ge,{children:[e.jsx(rt,{newsletters:n?.newsletters}),e.jsx(Ne,{})]})}),e.jsx(Se,{isLoading:!1,loadingComponent:e.jsx(e.Fragment,{}),children:e.jsxs(e.Fragment,{children:[e.jsx(ne,{"data-testid":"newsletters-card",children:e.jsx(oe,{children:e.jsx(at,{avgsData:O,initialTab:t,isAvgsLoading:!1,isLoading:D,subscribersData:u,totals:k})})}),e.jsx(me,{range:a,selectedNewsletterId:s,shouldFetchStats:!!h})]})})]}):e.jsx(ge,{to:"/"})};export{Vt as default};
